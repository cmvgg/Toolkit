#!/bin/bash

if ! command -v tcpdump &> /dev/null; then
    echo "tcpdump no está instalado. Por favor, instálalo e intenta de nuevo."
    exit 1
fi

if [ "$#" -ne 2 ]; then
    echo "Uso: $0 <num_threads> <output_file>"
    exit 1
fi

NUM_THREADS=$1
OUTPUT_FILE=$2

TEMP_FILE="/home/cmvgg/4/open_ports.txt"
> "$TEMP_FILE"

process_packets() {
    local thread_id=$1
    local temp_file="/home/cmvgg/4/tcpdump_captures/tcpdump_$thread_id.pcap"
    echo "Procesando captura en hilo $thread_id"
    
    # Extraer puertos TCP de los paquetes
    sudo tcpdump -nn -r "$temp_file" 2>/dev/null | awk '/Flags/ {print $3}' | grep -Eo '[0-9]+$' | sort -n | uniq >> "$TEMP_FILE"
    
    echo "Contenido del archivo temporal después de hilo $thread_id:"
    cat "$TEMP_FILE"
}

export -f process_packets
export TEMP_FILE

seq 1 "$NUM_THREADS" | parallel -j "$NUM_THREADS" process_packets

sort "$TEMP_FILE" | uniq > "$OUTPUT_FILE"
rm "$TEMP_FILE"
echo "Escaneo pasivo completo. Los puertos abiertos se han guardado en $OUTPUT_FILE"
cat "$OUTPUT_FILE"


./hardscan 127.0.0.1 /home/cmvgg/result_ports.txt
