#!/bin/bash

if ! command -v tcpdump &> /dev/null; then
    echo "tcpdump no está instalado. Por favor, instálalo e intenta de nuevo."
    exit 1
fi

if [ "$#" -ne 3 ]; then
    echo "Uso: $0 <ip> <num_threads> <output_file>"
    exit 1
fi

IP=$1
NUM_THREADS=$2
OUTPUT_FILE=$3

TEMP_DIR="/home/cmvgg/4/tcpdump_captures"
rm -rf "$TEMP_DIR"
mkdir -p "$TEMP_DIR"

capture_packets() {
    echo "iniciando capturas"
    local thread_id=$1
    local temp_file="$TEMP_DIR/tcpdump_$thread_id.pcap"
    echo "Iniciando captura en hilo $thread_id"
    sudo tcpdump -i lo host "$IP" -w "$temp_file" -c 100 &
    local TCPDUMP_PID=$!
    wait "$TCPDUMP_PID"
    echo "Captura completada en hilo $thread_id"
}

export -f capture_packets
export TEMP_DIR
export IP

seq 1 "$NUM_THREADS" | parallel -j "$NUM_THREADS" capture_packets
echo "Capturas completadas"

g++ -O3 -Wall -std=c++11 -fPIC $(python3 -m pybind11 --includes) hardscan.cpp -o hardscan $(python3-config --ldflags)

sudo chmod +x softscan2.sh
sudo ./softscan2.sh "$NUM_THREADS" "$OUTPUT_FILE"
